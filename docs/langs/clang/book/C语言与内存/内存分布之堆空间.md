# 内存分布之堆空间

栈空间是存放局部变量的存储器，主要在于栈可以出栈，入栈的操作，可以将我们的临时变量替换。只读空间可以认为是我们程序员在程序运行之前就已经设计好的数据空间。我们还需要一个运行时保留一段时间的空间-堆空间。

1.只读空间：静态空间，整个程序结束时释放内存，生存周期最长。

2.栈空间：运行时，函数内部使用的变量，函数一旦返回，就释放，生存周期在函数内。

3.堆空间：可以自由，自我管理分配和释放的空间，生存周期由程序员决定。

## 堆空间的分配

```c
malloc(int) //一旦成功分配，返回分配好的地址，我们需要接受这个地址去操作，所以我们用一个指针去接收这个地址。对于这个地址的读法，由程序员自由把握。输入参数指定分配的大小，单位是字节。
 char *p=(char *)malloc(100); //分配100个字节，分配的时候指定类型为char *类型，所以就可以存储100个字符。
if(p==NULL){
error;} //在分配之后，我们应该有这个判断，如果分配失败，比如指向一个不合法地址，我们就可以判断然后进行一些操作。
```

如果申请空间的malloc在一个函数中，函数每运行一次，空间就会申请一次，每次申请的空间都会存在。函数一旦返回，只是指向这片内存的指针为局部变量已经被销毁。下面这段代码就是内存泄漏，因为在这个函数里面我们在堆空间申请了100个字节，但是在函数返回之后，局部变量p被销毁，我们就不能找到这100个字节的地址，我们就不能再去访问它。这样的内存地址没有通过我们的释放，程序在运行过程中我们不能再次分配这些地址了，这些地址我们不能访问到也不能让它们再次被分配，这就是内存泄漏了。

![999.png](http://www.maiziedu.com/uploads/new_img/lIFzdqeraMJoABH0AV.png)

### 堆空间的释放

为了防止造成内存泄漏，我们要么在函数返回的时候返回它的地址，以便在后面继续访问这个地址，要么就是在函数内部直接对这片地址进行释放。

free(p); //将我们申请的地址给free函数，它会自动将这些内存交还给系统。所以每一个malloc都应该有一个free与之相对应。

这就是我们内存中三大空间的基本概念，随着我们后面课程的深入，我们对每一个空间的具体使用技巧还会有更深的理解。